import { RequestHandler } from "express";
import { fetchCategories, fetchProducts, fetchProductsById } from "../services/ProductService";
import { validatorError } from "../services/ErrorService";
import { AuthenticatedRequest, getPaginationQuery, ProductPaginatedQueryParams } from "../types/types";
import z from "zod";
import { getCartItemsById } from "../services/CartService";


export const getProducts: RequestHandler = async (req, res) => {
  const validated = ProductPaginatedQueryParams.safeParse(req.query);

  if (!validated.success) {
    return validatorError(res, validated.error);
  }

  const { limit, skip, category, order, search } = validated.data;

  console.log(category);

  return res.json({
    success: true,
    data: await fetchProducts(limit, skip, category, order, search)
  });
}

export const getProductCategories: RequestHandler = async (req, res, next) => {
  try {
    const items = await fetchCategories();

    return res.json({
      success: true,
      data: items
    });
  } catch (error) {
    next();
  }
}

export const routeParam = z.object({
  ids: z.preprocess((val) => {
    if (!Array.isArray(val)) {
      return [val];
    }
    return val;
  }, z.array(z.coerce.number())),
});
export const getProductByIds: RequestHandler = async (req: AuthenticatedRequest, res) => {
  if (!req.user) {
    return res.sendStatus(401)
  }

  const validated = routeParam.safeParse(req.query);

  if (!validated.success) {
    return validatorError(res, validated.error);
  }

  const { ids } = validated.data;

  return res.json({
    success: true,
    data: await getCartItemsById(req.user.id, ids)
  })
}
